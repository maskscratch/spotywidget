<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget de Spotify</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            overflow: hidden;
            background: transparent;
            color: white;
        }

        .spotify-widget-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .spotify-widget {
            position: relative;
            width: 400px;
            height: 120px;
            background: linear-gradient(135deg, rgba(15, 15, 35, 0.9) 0%, rgba(10, 10, 25, 0.85) 100%);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            overflow: hidden;
            box-shadow: 
                0 0 15px rgba(16, 185, 129, 0.15),
                0 0 30px rgba(16, 185, 129, 0.08);
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
            animation: widgetFloat 4s ease-in-out infinite alternate;
        }

        .album-art {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(16, 185, 129, 0.4);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .track-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .track-name {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artist-name {
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 0.5px;
            color: #10b981;
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-text {
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1DB954, #10b981);
            width: 0%;
            transition: width 1s linear;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
        }

        .auth-message {
            text-align: center;
            padding: 20px;
        }

        .auth-url {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 10px;
            color: #10b981;
            word-break: break-all;
            font-family: monospace;
            line-height: 1.4;
            cursor: text;
            user-select: all;
        }

        .auth-step {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            margin: 8px 0;
            text-align: left;
        }

        .error-message {
            color: #ff6b6b;
            font-size: 12px;
            text-align: center;
            margin: 10px 0;
        }

        .connection-status {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 2s ease-in-out infinite;
        }

        .connection-status.connected {
            background: #10b981;
        }

        @keyframes widgetFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(0.8);
            }
        }

        @media (max-width: 768px) {
            .spotify-widget {
                width: 320px;
                height: 100px;
                padding: 15px;
            }
            
            .album-art {
                width: 60px;
                height: 60px;
            }
            
            .track-name {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="spotify-widget-container">
        <div class="spotify-widget" id="widget">
            <div class="connection-status" id="connectionStatus"></div>
            
            <div class="album-art" id="albumArt">
                <img src="https://via.placeholder.com/80x80/1a1a1a/10b981?text=♪" alt="Album Art" id="albumImage">
            </div>
            
            <div class="track-info">
                <div class="track-name" id="trackName">Iniciando widget...</div>
                <div class="artist-name" id="artistName">Verificando conexión</div>
                <div class="status-text" id="statusText">Cargando</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('🎵 Spotify Widget iniciado');
        
        const SPOTIFY_CONFIG = {
            clientId: 'bad57584024a467e8ed3aa6676d1fd32',
            redirectUri: 'https://spotify-callback-service.netlify.app/.netlify/functions/callback',
            scopes: 'user-read-currently-playing user-read-playback-state'
        };

        class SpotifyWidget {
            constructor() {
                this.accessToken = null;
                this.refreshToken = null;
                this.isConnected = false;
                this.retryCount = 0;
                this.maxRetries = 3;
                
                this.elements = {
                    widget: document.getElementById('widget'),
                    trackName: document.getElementById('trackName'),
                    artistName: document.getElementById('artistName'),
                    albumImage: document.getElementById('albumImage'),
                    statusText: document.getElementById('statusText'),
                    progressBar: document.getElementById('progressBar'),
                    connectionStatus: document.getElementById('connectionStatus')
                };
                
                this.init();
            }
            
            init() {
                const hasToken = localStorage.getItem('spotify_access_token');
                
                // Mostrar estado de sincronización inicial
                this.elements.trackName.textContent = 'Sincronizando...';
                this.elements.artistName.textContent = 'Verificando conexión';
                this.elements.statusText.textContent = 'Cargando';
                
                const isShowingAuth = this.elements.widget.querySelector('.auth-message');
                
                console.log('🔄 Verificando conexión...', {
                    hasToken: !!hasToken,
                    isShowingAuth: !!isShowingAuth,
                    isConnected: this.isConnected
                });
                
                // Si hay token pero estamos mostrando auth, recargar
                if (hasToken && isShowingAuth) {
                    console.log('🔄 Token detectado, recargando...');
                    location.reload();
                    return;
                }
                
                // Si no hay token y no estamos mostrando auth, mostrar auth
                if (!hasToken && !isShowingAuth) {
                    console.log('❌ Sin token, mostrando auth');
                    this.showAuthMessage();
                    return;
                }
                
                // Si tenemos token pero no estamos conectados, verificar
                if (hasToken && !this.isConnected) {
                    console.log('🔍 Token existe pero no conectado, verificando...');
                    this.loadTokens();
                    this.verifyToken();
                }
                
                // Verificar conexión cada 10 segundos
                setInterval(() => this.checkConnection(), 10000);
            }
            
            loadTokens() {
                this.accessToken = localStorage.getItem('spotify_access_token');
                this.refreshToken = localStorage.getItem('spotify_refresh_token');
                console.log('📦 Tokens cargados:', {
                    hasAccess: !!this.accessToken,
                    hasRefresh: !!this.refreshToken
                });
            }
            
            saveTokens(accessToken, refreshToken = null) {
                this.accessToken = accessToken;
                localStorage.setItem('spotify_access_token', accessToken);
                
                if (refreshToken) {
                    this.refreshToken = refreshToken;
                    localStorage.setItem('spotify_refresh_token', refreshToken);
                }
                
                const expiresAt = Date.now() + (3600 * 1000); // 1 hora
                localStorage.setItem('spotify_token_expires', expiresAt);
                
                console.log('💾 Tokens guardados exitosamente');
            }
            
            async verifyToken() {
                console.log('🔍 Verificando token...', { token: this.accessToken?.substring(0, 20) + '...' });
                
                try {
                    const response = await fetch('https://api.spotify.com/v1/me', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });
                    
                    console.log('📡 Respuesta de verificación:', response.status);
                    
                    if (response.ok) {
                        console.log('✅ Token válido, iniciando polling');
                        this.isConnected = true;
                        this.elements.connectionStatus.classList.add('connected');
                        this.startPolling();
                    } else {
                        console.log('❌ Token inválido, limpiando y mostrando auth');
                        this.clearTokens();
                        this.showAuthMessage();
                    }
                } catch (error) {
                    console.error('❌ Error verificando token:', error);
                    this.elements.trackName.textContent = 'Error de conexión';
                    this.elements.artistName.textContent = 'Reintentando en 10s...';
                    this.elements.statusText.textContent = 'Error';
                }
            }
            
            clearTokens() {
                this.accessToken = null;
                this.refreshToken = null;
                this.isConnected = false;
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_refresh_token');
                localStorage.removeItem('spotify_token_expires');
                this.elements.connectionStatus.classList.remove('connected');
                console.log('🗑️ Tokens eliminados');
            }
            
            showAuthMessage() {
                const authUrl = `https://accounts.spotify.com/authorize?` +
                    `response_type=code&` +
                    `client_id=${SPOTIFY_CONFIG.clientId}&` +
                    `scope=${encodeURIComponent(SPOTIFY_CONFIG.scopes)}&` +
                    `redirect_uri=${encodeURIComponent(SPOTIFY_CONFIG.redirectUri)}&` +
                    `show_dialog=true`;
                
                this.elements.widget.innerHTML = `
                    <div class="connection-status"></div>
                    <div class="auth-message">
                        <div class="track-name" style="color: #ff6b6b; margin-bottom: 15px;">🔐 Spotify Desconectado</div>
                        
                        <div class="auth-step"><strong>1. Copia esta URL completa:</strong></div>
                        <div class="auth-url" onclick="this.select()">${authUrl}</div>
                        
                        <div class="auth-step"><strong>2. Pégala en tu navegador</strong></div>
                        <div class="auth-step"><strong>3. Autoriza la aplicación</strong></div>
                        <div class="auth-step"><strong>4. El widget se conectará automáticamente</strong></div>
                        
                        <div style="margin-top: 15px; font-size: 9px; color: rgba(255,255,255,0.5);">
                            ⚠️ Desde OBS no funcionan los clicks - usa la URL manualmente
                        </div>
                    </div>
                `;
                
                console.log('🔗 URL de autenticación generada');
            }
            
            async getCurrentTrack() {
                if (!this.accessToken || !this.isConnected) {
                    return;
                }
                
                try {
                    console.log('🎵 Obteniendo canción actual...');
                    const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });
                    
                    if (response.status === 401) {
                        console.log('🔐 Token expirado');
                        this.clearTokens();
                        this.showAuthMessage();
                        return;
                    }
                    
                    if (response.status === 204) {
                        console.log('⏸️ No hay música reproduciéndose');
                        this.showNoTrack();
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.is_playing && data.item) {
                        console.log('▶️ Actualizando canción:', data.item.name);
                        this.updateTrackInfo(data);
                        this.retryCount = 0; // Reset retry count on success
                    } else {
                        this.showNoTrack();
                    }
                    
                } catch (error) {
                    console.error('❌ Error obteniendo canción:', error);
                    this.retryCount++;
                    
                    if (this.retryCount >= this.maxRetries) {
                        this.showError('Error de conexión persistente');
                        this.retryCount = 0;
                    }
                }
            }
            
            updateTrackInfo(data) {
                const track = data.item;
                const artists = track.artists.map(artist => artist.name).join(', ');
                
                this.elements.trackName.textContent = track.name;
                this.elements.artistName.textContent = artists;
                this.elements.albumImage.src = track.album.images[0]?.url || 'https://via.placeholder.com/80x80/1a1a1a/10b981?text=♪';
                this.elements.statusText.textContent = data.is_playing ? 'Reproduciendo' : 'Pausado';
                
                // Actualizar barra de progreso
                if (data.progress_ms && track.duration_ms) {
                    const progressPercent = (data.progress_ms / track.duration_ms) * 100;
                    this.elements.progressBar.style.width = `${progressPercent}%`;
                }
            }
            
            showNoTrack() {
                this.elements.trackName.textContent = 'Sin reproducción activa';
                this.elements.artistName.textContent = 'Inicia música en Spotify';
                this.elements.statusText.textContent = 'Esperando';
                this.elements.albumImage.src = 'https://via.placeholder.com/80x80/1a1a1a/666666?text=♪';
                this.elements.progressBar.style.width = '0%';
            }
            
            showError(message) {
                this.elements.trackName.textContent = message;
                this.elements.artistName.textContent = 'Reintentando...';
                this.elements.statusText.textContent = 'Error';
                this.elements.albumImage.src = 'https://via.placeholder.com/80x80/1a1a1a/ff6b6b?text=!';
                this.elements.progressBar.style.width = '0%';
            }
            
            startPolling() {
                // Obtener canción inicial
                this.getCurrentTrack();
                
                // Actualizar cada 10 segundos
                setInterval(() => {
                    if (this.isConnected) {
                        this.getCurrentTrack();
                    }
                }, 10000);
            }
            
            checkConnection() {
                const hasToken = localStorage.getItem('spotify_access_token');
                const currentlyShowingAuth = this.elements.widget.querySelector('.auth-message');
                
                if (hasToken && currentlyShowingAuth) {
                    console.log('🔄 Token detectado, recargando widget...');
                    location.reload();
                }
            }
        }
        
        // Escuchar mensajes del callback
        window.addEventListener('message', function(event) {
            console.log('📨 Mensaje recibido:', event.data.type);
            
            if (event.data.type === 'SPOTIFY_AUTH_SUCCESS') {
                console.log('✅ Autenticación exitosa');
                
                try {
                    localStorage.setItem('spotify_access_token', event.data.accessToken);
                    localStorage.setItem('spotify_refresh_token', event.data.refreshToken);
                    localStorage.setItem('spotify_token_expires', Date.now() + (event.data.expiresIn * 1000));
                    console.log('💾 Tokens guardados, recargando...');
                } catch (error) {
                    console.error('❌ Error guardando tokens:', error);
                }
                
                location.reload();
            }
        });
        
        // Inicializar widget
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 DOM cargado, iniciando widget...');
            new SpotifyWidget();
        });
        
        // Función global para debugging
        window.clearSpotifyData = function() {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_refresh_token');
            localStorage.removeItem('spotify_token_expires');
            location.reload();
            console.log('🗑️ Datos de Spotify eliminados');
        };
    </script>
</body>
</html>
