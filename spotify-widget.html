<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget de Spotify</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            overflow: hidden;
            background: transparent;
            color: white;
        }

        .spotify-widget-container {
            position: absolute;
            top: 40px;
            right: 40px;
            z-index: 10;
        }

        .spotify-widget {
            position: relative;
            width: 400px;
            height: 120px;
            background: 
                linear-gradient(135deg, rgba(15, 15, 35, 0.9) 0%, rgba(10, 10, 25, 0.85) 100%);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            overflow: hidden;
            box-shadow: 
                0 0 30px rgba(16, 185, 129, 0.2),
                0 0 60px rgba(16, 185, 129, 0.1),
                inset 0 0 30px rgba(147, 51, 234, 0.05);
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
            animation: widgetFloat 4s ease-in-out infinite alternate;
        }

        .album-art {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(16, 185, 129, 0.4);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-art::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 0%, 
                rgba(16, 185, 129, 0.1) 50%, 
                transparent 100%);
            animation: albumShine 3s ease-in-out infinite;
        }

        .track-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .track-name {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artist-name {
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 0.5px;
            color: #10b981;
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .spotify-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .spotify-icon {
            width: 16px;
            height: 16px;
            background: #1DB954;
            border-radius: 50%;
            position: relative;
            animation: spotifyPulse 2s ease-in-out infinite;
        }

        .spotify-icon::after {
            content: '‚ô™';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: white;
        }

        .status-text {
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
        }

        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1DB954, #10b981);
            width: 0%;
            transition: width 1s linear;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
        }

        .widget-glow-top {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(16, 185, 129, 0.8), 
                rgba(29, 185, 84, 0.8), 
                transparent
            );
            filter: blur(1px);
            animation: glowFlow 4s linear infinite;
        }

        .floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(16, 185, 129, 0.6);
            border-radius: 50%;
            animation: particleFloat 6s ease-in-out infinite;
        }

        .particle:nth-child(1) {
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .particle:nth-child(2) {
            top: 60%;
            left: 80%;
            animation-delay: 2s;
        }

        .particle:nth-child(3) {
            top: 80%;
            left: 30%;
            animation-delay: 4s;
        }

        .no-track {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            letter-spacing: 1px;
        }

        .auth-instructions {
            text-align: center;
            padding: 20px;
        }

        .auth-url {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
            color: #10b981;
            word-break: break-all;
            font-family: monospace;
        }

        .auth-step {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin: 8px 0;
            text-align: left;
        }

        /* Animaciones */
        @keyframes widgetFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-5px); }
        }

        @keyframes albumShine {
            0%, 100% {
                transform: translateX(-100%) rotate(45deg);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
        }

        @keyframes spotifyPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(29, 185, 84, 0.8);
            }
        }

        @keyframes glowFlow {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes particleFloat {
            0%, 100% {
                transform: translateY(0px) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translateY(-10px) scale(1.2);
                opacity: 0.8;
            }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .spotify-widget-container {
                top: 20px;
                right: 20px;
            }
            
            .spotify-widget {
                width: 320px;
                height: 100px;
                padding: 15px;
            }
            
            .album-art {
                width: 60px;
                height: 60px;
            }
            
            .track-name {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="spotify-widget-container">
        <div class="spotify-widget">
            <div class="floating-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            
            <div class="album-art" id="albumArt">
                <img src="https://via.placeholder.com/80x80/1a1a1a/10b981?text=‚ô™" alt="Album Art" id="albumImage">
            </div>
            
            <div class="track-info">
                <div class="track-name" id="trackName">Conectando con Spotify...</div>
                <div class="artist-name" id="artistName">Preparando sistema de audio</div>
                <div class="spotify-status">
                    <div class="spotify-icon"></div>
                    <span class="status-text" id="statusText">Sincronizando</span>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="widget-glow-top"></div>
        </div>
    </div>

    <script>
        class SpotifyWidget {
            constructor() {
                this.accessToken = null;
                this.refreshToken = null;
                this.currentTrack = null;
                this.isPlaying = false;
                this.progress = 0;
                this.duration = 0;
                
                this.elements = {
                    trackName: document.getElementById('trackName'),
                    artistName: document.getElementById('artistName'),
                    albumImage: document.getElementById('albumImage'),
                    statusText: document.getElementById('statusText'),
                    progressBar: document.getElementById('progressBar')
                };
                
                this.init();
            }
            
            init() {
                // Verificar si hay tokens guardados
                this.loadTokens();
                
                if (!this.accessToken) {
                    this.showAuthMessage();
                } else {
                    this.startPolling();
                }
            }
            
            loadTokens() {
                this.accessToken = localStorage.getItem('spotify_access_token');
                this.refreshToken = localStorage.getItem('spotify_refresh_token');
            }
            
            saveTokens(accessToken, refreshToken = null) {
                this.accessToken = accessToken;
                localStorage.setItem('spotify_access_token', accessToken);
                
                if (refreshToken) {
                    this.refreshToken = refreshToken;
                    localStorage.setItem('spotify_refresh_token', refreshToken);
                }
            }
            
            showAuthMessage() {
                console.log('üîê Mostrando mensaje de autenticaci√≥n');
                
                // Generar URL de autenticaci√≥n
                const authUrl = `https://accounts.spotify.com/authorize?` +
                    `response_type=code&` +
                    `client_id=${SPOTIFY_CONFIG.clientId}&` +
                    `scope=${encodeURIComponent(SPOTIFY_CONFIG.scopes)}&` +
                    `redirect_uri=${encodeURIComponent(SPOTIFY_CONFIG.redirectUri)}&` +
                    `show_dialog=true`;
                
                // Mostrar instrucciones para OBS
                const widget = document.querySelector('.spotify-widget');
                widget.innerHTML = `
                    <div class="auth-instructions">
                        <div class="track-name" style="color: #ff6b6b; margin-bottom: 15px;">üîê Spotify Desconectado</div>
                        
                        <div class="auth-step">1. Copia esta URL:</div>
                        <div class="auth-url">${authUrl}</div>
                        
                        <div class="auth-step">2. √Åbrela en tu navegador</div>
                        <div class="auth-step">3. Autoriza la aplicaci√≥n</div>
                        <div class="auth-step">4. El widget se conectar√° autom√°ticamente</div>
                        
                        <div style="margin-top: 15px; font-size: 10px; color: rgba(255,255,255,0.5);">
                            ‚ö†Ô∏è Desde OBS no se pueden abrir popups
                        </div>
                    </div>
                `;
            }
            
            async getCurrentTrack() {
                console.log('üéµ Obteniendo canci√≥n actual...');
                
                // Verificar si tenemos token
                if (!this.accessToken) {
                    console.log('‚ùå No hay token de acceso');
                    this.showAuthMessage();
                    return;
                }
                
                // Renovar token si es necesario
                const tokenRefreshed = await refreshTokenIfNeeded();
                if (tokenRefreshed) {
                    console.log('üîÑ Token renovado');
                    this.loadTokens(); // Recargar tokens despu√©s de renovar
                }
                
                try {
                    console.log('üì° Haciendo petici√≥n a Spotify API...');
                    const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });
                    
                    console.log('üìä Respuesta de Spotify:', response.status);
                    
                    if (response.status === 401) {
                        console.log('üîê Token expirado o inv√°lido');
                        localStorage.removeItem('spotify_access_token');
                        localStorage.removeItem('spotify_refresh_token');
                        localStorage.removeItem('spotify_token_expires');
                        this.showAuthMessage();
                        return;
                    }
                    
                    if (response.status === 204) {
                        console.log('‚è∏Ô∏è No hay m√∫sica reproduci√©ndose');
                        this.showNoTrack();
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üé∂ Datos recibidos:', data);
                    
                    if (!data.is_playing) {
                        console.log('‚è∏Ô∏è M√∫sica pausada');
                        this.showNoTrack();
                    } else {
                        console.log('‚ñ∂Ô∏è Actualizando informaci√≥n de la canci√≥n');
                        this.updateTrackInfo(data);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error obteniendo canci√≥n actual:', error);
                    this.showError();
                }
            }
            
            async refreshAccessToken() {
                if (!this.refreshToken) {
                    this.showAuthMessage();
                    return;
                }
                
                // Aqu√≠ necesitar√≠as implementar la renovaci√≥n del token
                // Esto requiere un servidor backend para manejar el refresh token de forma segura
                console.log('Token refresh needed - implement server-side refresh');
                this.showAuthMessage();
            }
            
            updateTrackInfo(data) {
                if (!data.item) {
                    this.showNoTrack();
                    return;
                }
                
                const track = data.item;
                const artists = track.artists.map(artist => artist.name).join(', ');
                
                this.elements.trackName.textContent = track.name;
                this.elements.artistName.textContent = artists;
                this.elements.albumImage.src = track.album.images[0]?.url || 'https://via.placeholder.com/80x80/1a1a1a/10b981?text=‚ô™';
                
                this.isPlaying = data.is_playing;
                this.progress = data.progress_ms;
                this.duration = track.duration_ms;
                
                this.elements.statusText.textContent = this.isPlaying ? 'Reproduciendo' : 'Pausado';
                
                // Actualizar barra de progreso
                const progressPercent = (this.progress / this.duration) * 100;
                this.elements.progressBar.style.width = `${progressPercent}%`;
            }
            
            showNoTrack() {
                this.elements.trackName.textContent = 'Sin reproducci√≥n activa';
                this.elements.artistName.textContent = 'Inicia m√∫sica en Spotify';
                this.elements.statusText.textContent = 'Esperando';
                this.elements.albumImage.src = 'https://via.placeholder.com/80x80/1a1a1a/666666?text=‚ô™';
                this.elements.progressBar.style.width = '0%';
            }
            
            showError() {
                console.log('‚ùå Mostrando error');
                this.elements.trackName.textContent = 'Error de conexi√≥n';
                this.elements.artistName.textContent = 'Reintentando...';
                this.elements.statusText.textContent = 'Error';
                this.elements.albumImage.src = 'https://via.placeholder.com/80x80/1a1a1a/ff6b6b?text=!';
                this.elements.progressBar.style.width = '0%';
            }
            
            startPolling() {
                // Verificar conexi√≥n inicial
                this.checkConnection();
                
                // Actualizar cada 5 segundos
                setInterval(() => {
                    this.getCurrentTrack();
                }, 5000);
                
                // Actualizar progreso cada segundo si est√° reproduciendo
                setInterval(() => {
                    if (this.isPlaying && this.duration > 0) {
                        this.progress += 1000;
                        const progressPercent = Math.min((this.progress / this.duration) * 100, 100);
                        this.elements.progressBar.style.width = `${progressPercent}%`;
                    }
                }, 1000);
            }
            
            async checkConnection() {
                console.log('üîç Verificando conexi√≥n inicial...');
                try {
                    if (this.accessToken) {
                        console.log('‚úÖ Token encontrado, obteniendo canci√≥n...');
                        this.getCurrentTrack();
                    } else {
                        console.log('‚ùå No hay token guardado');
                        this.showAuthMessage();
                    }
                } catch (error) {
                    console.error('‚ùå Error en verificaci√≥n inicial:', error);
                    this.showAuthMessage();
                }
            }
        }
        
        // Inicializar el widget cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            new SpotifyWidget();
        });
        
        // Funci√≥n para configurar tokens (para uso en consola del navegador)
        window.setSpotifyTokens = function(accessToken, refreshToken) {
            localStorage.setItem('spotify_access_token', accessToken);
            if (refreshToken) {
                localStorage.setItem('spotify_refresh_token', refreshToken);
            }
            location.reload();
        };
        
        // Configuraci√≥n de Spotify
        const SPOTIFY_CONFIG = {
            clientId: 'bad57584024a467e8ed3aa6676d1fd32',
            redirectUri: 'https://spotify-callback-service.netlify.app/.netlify/functions/callback',
            scopes: 'user-read-currently-playing user-read-playback-state'
        };
        
        // Funci√≥n para autenticar con servicio online
        window.authenticateSpotify = function() {
            console.log('üöÄ Iniciando autenticaci√≥n de Spotify...');
            console.log('‚ö†Ô∏è IMPORTANTE: Si est√°s en OBS, copia la URL que aparece en el widget');
            
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `response_type=code&` +
                `client_id=${SPOTIFY_CONFIG.clientId}&` +
                `scope=${encodeURIComponent(SPOTIFY_CONFIG.scopes)}&` +
                `redirect_uri=${encodeURIComponent(SPOTIFY_CONFIG.redirectUri)}&` +
                `show_dialog=true`;
            
            console.log('üîó URL de autenticaci√≥n:', authUrl);
            
            // Intentar abrir popup (funciona en navegador, no en OBS)
            try {
                const popup = window.open(authUrl, 'spotify-auth', 'width=500,height=600');
                if (!popup) {
                    console.log('‚ùå Popup bloqueado - usa la URL del widget');
                }
            } catch (error) {
                console.log('‚ùå No se puede abrir popup desde OBS - usa la URL del widget');
            }
        };
        
        // Escuchar mensajes del callback
        window.addEventListener('message', function(event) {
            console.log('üì® Mensaje recibido:', event);
            
            // Permitir mensajes del callback service
            if (event.origin !== 'https://spotify-callback-service.netlify.app' && 
                event.origin !== window.location.origin) return;
            
            if (event.data.type === 'SPOTIFY_AUTH_SUCCESS') {
                console.log('‚úÖ Autenticaci√≥n exitosa, guardando tokens...');
                localStorage.setItem('spotify_access_token', event.data.accessToken);
                localStorage.setItem('spotify_refresh_token', event.data.refreshToken);
                localStorage.setItem('spotify_token_expires', Date.now() + (event.data.expiresIn * 1000));
                console.log('üîÑ Recargando p√°gina...');
                location.reload();
            }
        
        // Verificar conexi√≥n cada 10 segundos por si se conecta desde otro lugar
        setInterval(() => {
            const hasToken = localStorage.getItem('spotify_access_token');
            const currentlyShowingAuth = document.querySelector('.auth-instructions');
            
            if (hasToken && currentlyShowingAuth) {
                console.log('üîÑ Token detectado, recargando widget...');
                location.reload();
            }
        }, 10000);
        
        // Funci√≥n para renovar token autom√°ticamente
        async function refreshTokenIfNeeded() {
            const expiresAt = localStorage.getItem('spotify_token_expires');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            
            if (!expiresAt || !refreshToken) {
                console.log('‚ö†Ô∏è No hay datos de expiraci√≥n o refresh token');
                return false;
            }
            
            // Renovar 5 minutos antes de expirar
            if (Date.now() >= (parseInt(expiresAt) - 300000)) {
                console.log('üîÑ Token pr√≥ximo a expirar, renovando...');
                try {
                    const response = await fetch('https://spotify-callback-service.netlify.app/.netlify/functions/refresh', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refreshToken })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Token renovado exitosamente');
                        localStorage.setItem('spotify_access_token', data.accessToken);
                        localStorage.setItem('spotify_token_expires', Date.now() + (data.expiresIn * 1000));
                        return true;
                    } else {
                        console.log('‚ùå Error renovando token:', response.status);
                    }
                } catch (error) {
                    console.error('‚ùå Error renovando token:', error);
                }
            }
            return false;
        };
    </script>
</body>
</html>
